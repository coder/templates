name: "Push Templates"
description: "Pushes a singular Coder template to a deployment"

inputs:
  deployment_dir:
    description: "Top-level folder for this deployment (e.g. prod.example.com)"
    required: true
  coder_url:
    description: "Coder deployment URL, e.g. https://prod.example.com"
    required: true
  coder_session_token:
    description: "Coder session token for authentication"
    required: true
  activate:
    description: "Whether to activate the new template version"
    required: false
    default: "false"
  template:
    description: "Template name to push"
    required: true
  template_dir:
    description: "Directory containing the template"
    required: true
  template_variables:
    description: "Template variables to be used by the Terraform template."
    required: false
    default: ""
  org:
    description: "Organization name"
    required: true

runs:
  using: "composite"
  steps:
    - name: Set up Coder CLI
      uses: coder/setup-action@v1
      with:
        access_url: ${{ inputs.coder_url }}
        coder_session_token: ${{ inputs.coder_session_token }}

    - id: meta
      name: Compute version name and message
      shell: bash
      run: |
        set -euo pipefail
        echo "version_name=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
        echo "message=$(git log --format=%s -n 1 ${{ github.sha }})" >> "$GITHUB_OUTPUT"

    - name: Push template
      shell: bash
      run: |
        set -euo pipefail
        echo "Pushing template '${{ inputs.template }}' for org '${{ inputs.org }}' from '${{ inputs.template_dir }}'"
        TEMPLATE_VARS=${{ inputs.template_variables }}
        echo "$TEMPLATE_VARS"
        test -z "$TEMPLATE_VARS" || echo $?
        if [ -z "$TEMPLATE_VARS" ]; then
            TEMPLATE_VARS=""
        else
            TEMPLATE_VARS="--var $(echo $TEMPLATE_VARS | jq -r 'fromjson | to_entries | map("\(.key)=\(.value)") | join(",")')"
        fi
        echo "$TEMPLATE_VARS"

        # coder templates push "${{ inputs.template }}" \
        #   --org="${{ inputs.org }}" \
        #   --directory="${{ inputs.template_dir }}" \
        #   --name="${{ steps.meta.outputs.version_name }}" \
        #   --message="${{ steps.meta.outputs.message }}" \
        #   --activate="${{ inputs.activate }}" \
        #   --yes $TEMPLATE_VARS
          
          

          